<!DOCTYPE html>
<html>
<head>
  <title>iQuestion</title>
  <link rel="stylesheet" type="text/css" href="{{option.stylecss}}">
  <script type="text/javascript">
    var currentStage = 0;
    var size = {{option.size}};
    var col = {{option.col}};
    var row = {{option.row}};
    var margin = {{option.margin}};
    var shouldFlick = false;
    var flickers = [];

    window.onload = function() {
      initImageViews();
      document.onclick = function(e) {
        nextStage();
      }
      flickingImageN = Math.floor(Math.random() * row * col);
      triggerFlick();
      flick();
    }

    function triggerFlick() {
      var done = false;
      var counter = 0;
      while (!done && counter < 640) {
        var n = Math.floor(Math.random() * row * col);
        var ex = false;
        for (var i = 0; i<flickers.length; i++) {
          if (flickers[i].N == n) {
            ex = true;
          }
        }
        if (!ex) {
          flickers.push(new Flick(n));
          done = true;
        }
        counter ++;
      }
      setTimeout(triggerFlick, Math.floor(Math.random() * 50))
    }

    function Flick(imageN) {
      this.direction = -1;
      this.speed = 0.0012 * (0.5 + 2 * Math.random());
      this.time = 0;
      this.maxTime = 2;
      this.opacity = 1;
      this.N = imageN;
      this.shouldFlick = true;

      this.init = function() {
        this.opacity = 1;
        this.direction = -1;
        this.time = 0;
      }

      this.flick = function() {
        this.opacity += this.direction * this.speed;
        if (this.opacity < 0 || this.opacity > 1) {
          this.direction *= -1;
          this.opacity += this.direction * this.speed;
          this.time += 1;
        }
        document.getElementById('image'+this.N).style.opacity = this.opacity;
        if (this.time >= this.maxTime) {
          this.shouldFlick = false;
        }
      }
    }

    var flickingImageN = 0;
    var currentFlickDirection = -1;
    var flickingSpeed = 0.01;
    var currentFlickingTime = 0;
    var maxFlickingTime = 2;
    var currentOpacity = 1;

    function initFlick() {
      currentOpacity = 1;
      currentFlickDirection = -1;
      currentFlickingTime = 0;
      flickingImageN = Math.floor(Math.random() * col * row);
    }

    function flick() {
      for(var i = 0; i<flickers.length; i++) {
        var f = flickers[i];
        f.flick();
      }
      for(var i = flickers.length-1; i>=0; i--) {
        if (!flickers[i].shouldFlick) {
          flickers.splice(i, 1);
        }
      }
      window.requestAnimationFrame(flick);
    }

    function startFlick() {
      shouldFlick = true;
    }

    function stopFlick() {
      shouldFlick = false;
      document.getElementById('image'+flickingImageN).style.opacity = 1;
      initFlick();
    }

    function nextStage() {
      if (currentStage == 0) {
        // showAllImages();
        showDiv(document.getElementById('image_container'));
        startFlick();
        currentStage = 1;
      } else if (currentStage == 1) {
        stopFlick()
        hideAllImages();
        setTimeout(function(){showImage(Math.floor(Math.random()*row*col))}, 3500);
        setTimeout(function(){showDiv(document.getElementById('tagline'))}, 4500);
        currentStage = 2;
      } else if (currentStage == 2) {
        hideAllImages();
        hideDiv(document.getElementById('tagline'));
        setTimeout(function(){showAllImages();}, 2000);
        currentStage = 1;
      }
    }

    function buildStyle(styleDict) {
      var styleString = '';
      for (var k in styleDict) {
        styleString += k + ':' + styleDict[k] + ';'
      }
      return styleString;
    }

    function getImageAddress(index) {
      var filename = (index+1) + '';
      while (filename.length < 4) {
        filename = '0' + filename;
      }

      return '{{option.image56}}' + filename + '.jpg';
    }

    function initImageViews() {
      var centerY = (size * row + margin * (row - 1))/2;
      var centerX = (size * col + margin * (col - 1))/2;
      var offsetY = screen.height/2 - centerY;
      var offsetX = screen.width/2 - centerX;
      for (var colI = 0; colI < col; colI ++) {
        for (var rowI = 0; rowI < row; rowI ++) {
          var htmlImage = new Image();
          var top = rowI * (size + margin) + offsetY;
          var left = colI * (size + margin) + offsetX;
          htmlImage.style = buildStyle({
            position: 'absolute',
            width: size + 'px',
            height: size + 'px',
            top: top + 'px',
            left: left + 'px',
            'background-color': 'black',
            color: 'white',
            opacity: 1
          });
          htmlImage.id = 'image'+(colI * row + rowI);
          htmlImage.alt = colI + ', ' + rowI;
          htmlImage.src = getImageAddress(colI * row + rowI);
          document.getElementById('image_container').appendChild(htmlImage);
        }
      }
    }

    function showAllImages() {
      for (var i = 0; i < row * col; i++) {
        var im = document.getElementById('image' + i);
        im.timer = setTimeout(function(el, n){
          return function(){
            if (n == row * col - 1) {
              startFlick();
            }
            el.style.opacity = 1;
          }
        }(im, i), 0 * i);
      }
    }

    function hideAllImages() {
      for (var i = 0; i < row * col; i++) {
        im = document.getElementById('image'+i);
        clearTimeout(im.timer);
        im.style.opacity = 0;
      }
    }

    function showImage(imid) {
      var im = document.getElementById('image' + imid);
      im.style.opacity = 1;
    }

    function hideImage(imid) {
      var im = document.getElementById('image' + imid);
      im.style.opacity = 0;
    }

    function showDiv(div) {
      var classes = div.className.split(' ');
      var newClasses = ['fadein'];
      for (var c of classes) {
        if (c == 'hidden' || c == 'fadeout') {

        } else {
          newClasses.push(c);
        }
      }
      div.className = newClasses.join(' ');
    }

    function hideDiv(div) {
      var classes = div.className.split(' ');
      var newClasses = ['fadeout'];
      for (var c of classes) {
        if (c == 'fadein') {

        } else {
          newClasses.push(c);
        }
      }
      div.className = newClasses.join(' ');
    }

  </script>
</head>
<body>
  <div id='main_stage' class='exhibit-stage'>
    <div id='image_container' class='exhibit-container hidden'>
    </div>
    <div id='tagline' class='exhibit-tagline hidden'>
      I Question이 당신의 사진을 좋아합니다.
    </div>
  </div>
</body>
</html>
