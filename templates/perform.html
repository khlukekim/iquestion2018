<!DOCTYPE html>
<html>
<head>
  <title>I Question Performance Page</title>
  <link rel="stylesheet" type="text/css" href="{{option.stylecss}}">
  <script type="text/javascript" src="{{option.jquery}}"></script>
</head>
<body>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>

  <script type="text/javascript">
    var perf_image_divs = [];
    function get_image_div(i){
      if (perf_image_divs.length > i) {
        return perf_image_divs[i];
      } else {
        var d1 = document.createElement('div');
        d1.id = 'perf-image-' + i;
        d1.className = 'perf-image';
        d1.style.display = 'inline-block';
        d1.style.position = 'relative';
        var im = document.createElement('img');
        im.id = 'perf-image-inner-' + i;
        im.style.width='100%';
        im.style.height='100%';
        im.onload = (function(n) {return function(event){imageloaded(event.target, n);};})(i);
        d1.appendChild(im);
        var d2 = document.createElement('div');
        d2.id = 'perf-image-rank-'+i;
        d2.style.width = '100%';
        d2.style.height = '{{option.height/2}}px';
        d2.style.lineHeight = 1;
        d2.style.position = 'absolute';
        d2.style.top = 0;
        d2.style.paddingTop = '{{option.height/4}}px';
        d2.style.paddingBottom = '{{option.height/4}}px';
        d2.style.textAlign = 'center';
        d2.style.vwSrticalAlign = 'middle';
        d2.style.fontSize = '{{option.height/2}}px';
        d2.style.color = 'white';
        d2.style.backgroundColor = 'rgba(0,0,0,0.5)';
        d2.style.display = 'none';
        d1.appendChild(d2);
        perf_image_divs.push(d1);
        document.getElementById('stage1').appendChild(d1);

        var d3 = document.createElement('div');
        d3.id = 'perf2-image-div-' + i;
        d3.className = 'perf-image perf2-image';
        d3.style.display = 'inline-block';
        d3.style.position = 'absolute';
        var im2 = document.createElement('img');
        im2.id = 'perf2-image-'+i;
        im2.style.width = '100%';
        im2.style.height = '100%';
        d3.appendChild(im2);
        var d4 = document.createElement('div');
        d4.id = 'perf2-image-rank-'+i;
        d4.style.width = '100%';
        d4.style.height = '100%';
        d4.style.lineHeight = 1;
        d4.style.position = 'absolute';
        d4.style.top = 0;
        d4.style.virticalAlign = 'middle';
        d4.style.textAlign = 'center';
        d4.style.fontSize = '{{option.height/2}}px';
        d4.style.color = 'white';
        d4.style.backgroundColor = 'rgba(0,0,0,0.5)';
        d4.style.display = 'none';
        d3.appendChild(d4);

        document.getElementById('stage2').appendChild(d3);
        return d1;
      }
    }
    var sessionHash = Math.random().toString(10);
    var option = {
      width: {{option.width}},
      height: {{option.height}},
      fontsize: {{option.fontsize}},
      cellsize: {{option.cellsize}}
    };

    var exWindow = null;
    var socket = io.connect('http://'+document.domain + ':' + location.port);
    socket.on('connect', function() {
      console.log('socket connected');
      socket.emit('perform join', sessionHash);
    })
    socket.on('disconnect', function() {
	    console.log('discon')
    });
    socket.on('erorr', function(e){
	    console.log(e)
    });
    socket.on('control message', function(data) {
      try {
        console.log(data);
        var message = data.split(':');
        if (message[0] == 'stage') {
          stage(Number(message[1]));
          if (message[1] == '1') {
            slideLeft = 0;
          }
          if (message[1] == '3' && message.length > 2) {
            stage3(Number(message[2]));
          }
        } else if (message[0] == 'words') {
          document.getElementById('stage5').innerHTML = decodeURIComponent(message[1]).replace('/\n/g', '<br>');
        } else if (message[0] == 'images') {
          images = message[1].split(',');
          if (images[0] == '') {
            images.splice(0, 1);
          }
          var d = document.getElementById('stage1');
          var d2 = document.getElementById('stage2');
          while(d.children.length > images.length) {
            d.removeChild(d.children[d.children.length - 1]);
          }
          while(d2.children.length > images.length) {
            d2.removeChild(d2.children[d2.children.length - 1]);
          }
          for(var i = 0; i<images.length;  i++) {
            var div = get_image_div(i);
            document.getElementById('perf-image-inner-'+i).src = '{{option.imageoriginal}}' + images[i];
          }
        } else if (message[0] == 'fontsize') {
          document.getElementById('stage5').style.fontSize = message[1] + 'px';
        } else if (message[0] == 'ex') {
          if (message[1] == 'open') {
            exWindow = window.open('/ex/56/64/10/4');
          } else if (message[1] == 'close') {
            exWindow.close();
          }
        } else if (message[0] == 'scores') {
          scores = message[1].split(',');
          if (scores[0] == '') {
            scores.splice(0, 1);
          }
          positions = [];
          for (var i = 0; i< scores.length; i++) {
            positions.push(i+1);
          }
          positions.sort(function(a,b){
            var k = parseInt(scores[a-1])-parseInt(scores[b-1]);
            if (k < 0 ) {
              return -1;
            } else if (k > 0) {
              return 1;
            } else {
              return 0;
            }
          });
          for (var i = 0; i<images.length; i++) {
            var div = get_image_div(i);
            document.getElementById('perf-image-rank-'+i).innerHTML = positions[i];
            document.getElementById('perf2-image-rank-'+i).innerHTML = positions[i];
          }
        } else if (message[0] == 'rank') {
          if (message[1] == 'show') {
            for (var i = 0; i<images.length; i++) {
              document.getElementById('perf-image-rank-'+i).style.display = 'block';
              document.getElementById('perf2-image-rank-'+i).style.display = 'block';
            }
            document.getElementById('perf3-rank').style.display = 'block';
          } else if (message[1] == 'hide') {
            for (var i = 0; i<images.length; i++) {
              document.getElementById('perf-image-rank-'+i).style.display = 'none';
              document.getElementById('perf2-image-rank-'+i).style.display = 'none';
            }
            document.getElementById('perf3-rank').style.display = 'none';
          }
        }
      } catch (e) {
        console.log(e);
      }
    });

    window.onload = function () {
      //window.requestAnimationFrame(slideImage);
      stage(0);
      initImageViews();
    };

    var updating = false;
    var images = [];
    var scores = [];
    var positions = [];

    function getUpdated() {
      console.log(Date.now());
      if (!updating) {
        updating = true;
        $.ajax({
          url: '/pf-update/'+sessionHash,
          success: updated,
          complete: function() {
            updating = false;
            getUpdated();
          },
          timeout: 10000
        });
      }
    }

    function updated(data) {
      try {
        console.log(data);
        if (data.m == '') {
          console.log(data);
        }
        var message = data.m.split(':');
        if (message[0] == 'stage') {
          stage(Number(message[1]));
          if (message[1] == '1') {
            slideLeft = 0;
          }
          if (message[1] == '3' && message.length > 2) {
            stage3(Number(message[2]));
          }
        } else if (message[0] == 'words') {
          document.getElementById('stage5').innerHTML = decodeURIComponent(message[1]).replace('/\n/g', '<br>');
        } else if (message[0] == 'images') {
          images = message[1].split(',');
          for(var i = 0; i<images.length;  i++) {
            document.getElementById('perf-image-'+i).src = '{{option.userimage}}' + images[i];
          }
        } else if (message[0] == 'fontsize') {
          document.getElementById('stage5').style.fontSize = message[1] + 'px';
        } else if (message[0] == 'scores') {
          scores = message[1].split(',');
        }
      } catch (e) {
        console.log(e);
      }
    }

    function stage3(i) {
      var im = document.getElementById('perf3-image');
      im.src = document.getElementById('perf-image-inner-' + i).src;
      im.style.marginLeft = (option.width - imageWidthList[i] * option.height / imageHeightList[i] - 0) / 2 + 'px';
      var d = document.getElementById('perf3-rank');
      d.innerHTML = positions[i];
      d.style.marginLeft = im.style.marginLeft;
    }


var stageNames = ['stage0', 'stage1', 'stage2', 'stage3', 'stage4', 'stage5'];
var stageVisiblity = ['block', 'block', 'block', 'block', 'block', 'table-cell'];

var N_STAGE = stageNames.length;

    function stage(stageID) {
      for(var i = 0; i < N_STAGE; i++) {
        document.getElementById(stageNames[i]).style.display = (i==stageID)?stageVisiblity[i]:'none';
      }
    }

    var imageWidthList = [];
    var imageHeightList = [];

    var slideWidth = 0;

    function imageloaded(e, number) {
      e.width = option.height;
      e.height = option.height;
      imageWidthList[number] = e.width;
      imageHeightList[number] = option.height;
      document.getElementById('perf-image-'+number).style.width = e.width + 'px';
      document.getElementById('perf-image-'+number).style.height= e.height + 'px';

      slideWidth = imageWidthList.reduce(function(a, b){return a+b+6}, 0);
      document.getElementById('stage1').style.width = slideWidth + 'px';
      document.getElementById('perf2-image-'+number).src = e.src;
      var left = 0;
      for (var i = 0; i< images.length; i++) {
        var im = document.getElementById('perf2-image-div-'+i);
        im.style.left = left + 'px';
        var w = imageWidthList[i] * Math.min(1, option.width / slideWidth);
        left += w;
        im.style.width = w-1 + 'px';
        var h = imageHeightList[i] / imageWidthList[i] * w;
        im.style.height = h + 'px';
        im.style.top = (option.height - h) / 2 + 'px';
        var imr = document.getElementById('perf2-image-rank-'+i);
        imr.style.height = h / 2 + 'px';
        imr.style.fontSize = h / 2 + 'px';
        imr.style.paddingTop = h / 4 + 'px';
        imr.style.paddingBottom = h / 4 + 'px';
      }
    }
    var direction = -1;
    var slideLeft = 0;
    var slideSpeed = 1;

    function slideImage() {
      slideLeft += Math.floor(direction * slideSpeed * (2 + 8 * Math.pow(Math.min(1, Math.min(Math.abs(slideLeft), Math.abs(slideWidth - option.width + slideLeft))/100), 2) / 10));
      if ((-slideLeft > slideWidth - option.width) ||
      (slideLeft > 0)) {
        direction = - direction;
        slideLeft += direction * slideSpeed;
      }
      document.getElementById('stage1').style.left = slideLeft + 'px';
      window.requestAnimationFrame(slideImage);
    }

    function buildStyle(styleDict) {
      var styleString = '';
      for (var k in styleDict) {
        styleString += k + ':' + styleDict[k] + ';'
      }
      return styleString;
    }

    function getImageAddress(index) {
      var filename = (index+1) + '';
      while (filename.length < 4) {
        filename = '0' + filename;
      }

      return '{{option.image56}}' + filename + '.jpg';
    }

    function initImageViews() {
      var size = option.cellsize;
      var row = 10;
      var col = 64;
      var margin = 4;
      var centerY = (size * row + margin * (row - 1))/2;
      var centerX = (size * col + margin * (col - 1))/2;
      var offsetY = option.height/2 - centerY;
      var offsetX = option.width/2 - centerX;
      for (var colI = 0; colI < col; colI ++) {
        for (var rowI = 0; rowI < row; rowI ++) {
          var htmlImage = new Image();
          var top = rowI * (size + margin) + offsetY;
          var left = colI * (size + margin) + offsetX;
          htmlImage.style = buildStyle({
            position: 'absolute',
            width: size + 'px',
            height: size + 'px',
            top: top + 'px',
            left: left + 'px',
            'background-color': 'black',
            color: 'white',
            opacity: 1
          });
          htmlImage.id = 'image'+(colI * row + rowI);
          htmlImage.alt = colI + ', ' + rowI;
          htmlImage.src = getImageAddress(colI * row + rowI);
          document.getElementById('image_container').appendChild(htmlImage);
        }
      }
    }
  </script>
  <div id='stage' class='perf-stage' style='width:{{option.width}}px; height:{{option.height}}px'>
    <div id='stage0' style='display: none;'></div>
    <div id='stage1' class='perf-image-wrapper' style='display:none; height:{{option.height}}px; width: 10000px'>
    </div>
    <div id='stage2' style='display:none;  width: {{option.width}}px; height: {{option.height}}px; vertical-align: center;'>
    </div>
    <div id='stage3' style='display:none; width: {{option.width}}px; height: {{option.height}}px; padding:0'>
      <div id='perf3-image-div' style='display:inline-block;height: 100%; position:relative;'>
        <img id='perf3-image' style='max-width: 100%; height:100%;'>
        <div id='perf3-rank' style="width: {{option.height}}px; height: {{option.height/2}}px; line-height: 1; position: absolute; top: 0; padding-top: {{option.height/4}}px; padding-bottom: {{option.height/4}}px; text-align: center; font-size: {{option.height/2}}px; color: white; background-color: rgba(0,0,0,0.5); display: none;"></div>

      </div>
    </div>
    <div id='stage4' style='display: none; width {{option.width}}px; height: {{option.height}}px;'>
    <div id='image_container' class='exhibit-container'>
    </div>
    </div>
    <div id='stage5' style='display: none; vertical-align: middle; width: {{option.width}}px; height: {{option.height}}px; color: white; font-size: {{option.fontsize}}px; line-height: 1; text-align: center;'>
      <p>
      TEST WORD LIST 단어 하나 둘 셋
      </p>
    </div>
  </div>
</body>
</html>
