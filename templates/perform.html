<!DOCTYPE html>
<html>
<head>
  <title>I Question Performance Page</title>
  <link rel="stylesheet" type="text/css" href="{{option.stylecss}}">
  <script type="text/javascript" src="{{option.jquery}}"></script>
</head>
<body>
  <script type="text/javascript">
    var option = {
      width: {{option.width}},
      height: {{option.height}},
      fontsize: {{option.fontsize}},
      cellsize: {{option.cellsize}}
    };

    window.onload = function () {
      window.requestAnimationFrame(slideImage);
      getUpdated();
      stage(0);
      initImageViews();
    };

    var updating = false;
    var images = [];

    function getUpdated() {
      if (!updating) {
        updating = true;
        $.ajax({
          url: '/pf-update',
          success: updated,
          complete: function() {
            updating = false;
            getUpdated();
          },
          timeout: 10000
        });
      }
    }

    function updated(data) {
      try {
        console.log(data);
        var message = data.m.split(':');
        if (message[0] == 'stage') {
          stage(Number(message[1]));
          if (message[1] == '1') {
            slideLeft = 0;
          }
          if (message[1] == '3' && message.length > 2) {
            stage3(Number(message[2]));
          }
        } else if (message[0] == 'words') {
          document.getElementById('stage5').innerHTML = message[1];
        } else if (message[0] == 'images') {
          images = message[1].split(',');
          for(var i = 0; i<Math.min(images.length, 10);  i++) {
            document.getElementById('perf-image-'+i).src = '{{option.userimage}}' + images[i];
          }
        } else if (message[0] == 'fontsize') {
          document.getElementById('stage5').style.fontSize = message[1] + 'px';
        }
      } catch (e) {
        console.log(e);
      }
    }

    function stage3(i) {
      var im = document.getElementById('perf3-image');
      im.src = document.getElementById('perf-image-' + i).src;
      im.style.marginLeft = (option.width - imageWidthList[i] * option.height / imageHeightList[i] - 0) / 2 + 'px';
    }


var stageNames = ['stage0', 'stage1', 'stage2', 'stage3', 'stage4', 'stage5'];

var N_STAGE = stageNames.length;

    function stage(stageID) {
      for(var i = 0; i < N_STAGE; i++) {
        document.getElementById(stageNames[i]).style.display = (i==stageID)?'block':'none';
      }
    }

    var imageWidthList = [];
    var imageHeightList = [];
    for(var i = 0; i < 10; i++) {
      imageWidthList.push(1000);
      imageHeightList.push(1000);
    }
    var slideWidth = 10000;

    function imageloaded(e, number) {
      imageWidthList[number] = e.width;
      imageHeightList[number] = e.height;
      slideWidth = imageWidthList.reduce(function(a, b){return a+b}, 0);
      document.getElementById('stage1').style.width = slideWidth + 'px';
      document.getElementById('perf2-image-'+number).src = e.src;
      var left = 0;
      for (var i = 0; i< 10; i++) {
        var im = document.getElementById('perf2-image-'+i);
        im.style.left = left + 'px';
        var w = imageWidthList[i] / slideWidth * option.width;
        left += w;
        im.style.width = w + 'px';
        var h = imageHeightList[i] / imageWidthList[i] * w;
        im.style.top = (option.height - h) / 2 + 'px';
      }
    }
    var direction = -1;
    var slideLeft = 0;
    var slideSpeed = 1;

    function slideImage() {
      slideLeft += Math.floor(direction * slideSpeed * (2 + 8 * Math.pow(Math.min(1, Math.min(Math.abs(slideLeft), Math.abs(slideWidth - option.width + slideLeft))/100), 2) / 10));
      if ((-slideLeft > slideWidth - option.width) ||
      (slideLeft > 0)) {
        direction = - direction;
        slideLeft += direction * slideSpeed;
      }
      document.getElementById('stage1').style.left = slideLeft + 'px';
      window.requestAnimationFrame(slideImage);
    }

    function buildStyle(styleDict) {
      var styleString = '';
      for (var k in styleDict) {
        styleString += k + ':' + styleDict[k] + ';'
      }
      return styleString;
    }

    function getImageAddress(index) {
      var filename = (index+1) + '';
      while (filename.length < 4) {
        filename = '0' + filename;
      }

      return '/static/images/' + filename + '.jpg';
    }

    function initImageViews() {
      var size = option.cellsize;
      var row = 10;
      var col = 60;
      var margin = 4;
      var centerY = (size * row + margin * (row - 1))/2;
      var centerX = (size * col + margin * (col - 1))/2;
      var offsetY = option.height/2 - centerY;
      var offsetX = option.width/2 - centerX;
      for (var colI = 0; colI < col; colI ++) {
        for (var rowI = 0; rowI < row; rowI ++) {
          var htmlImage = new Image();
          var top = rowI * (size + margin) + offsetY;
          var left = colI * (size + margin) + offsetX;
          htmlImage.style = buildStyle({
            position: 'absolute',
            width: size + 'px',
            height: size + 'px',
            top: top + 'px',
            left: left + 'px',
            'background-color': 'black',
            color: 'white',
            opacity: 1
          });
          htmlImage.id = 'image'+(colI * row + rowI);
          htmlImage.alt = colI + ', ' + rowI;
          htmlImage.src = getImageAddress(colI * row + rowI);
          document.getElementById('image_container').appendChild(htmlImage);
        }
      }
    }
  </script>
  <div id='stage' class='perf-stage' style='width:{{option.width}}px; height:{{option.height}}px'>
    <div id='stage0' style='display: none;'></div>
    <div id='stage1' class='perf-image-wrapper' style='display:none; height:{{option.height}}px; width: 10000px'>
      {% for i in range(10) %}
      <img id='perf-image-{{i}}' class='perf-image' src="{{option.imageoriginal}}{{'%04d' % (range(1, 1001) | random) }}.jpg" onload='imageloaded(event.target, {{i}})'>
      {% endfor %}
    </div>
    <div id='stage2' style='display:none;  width: {{option.width}}px; height: {{option.height}}px; vertical-align: center;'>
      {% for i in range(10) %}
      <img id='perf2-image-{{i}}' class='perf-image perf2-image'>
      {% endfor %}
    </div>
    <div id='stage3' style='display:none; width: {{option.width}}px; height: {{option.height}}px; padding:0'>
      <img id='perf3-image' style='height: 100%;'>
    </div>
    <div id='stage4' style='display: none; width {{option.width}}px; height: {{option.height}}px;'>
    <div id='image_container' class='exhibit-container'>
    </div>
    </div>
    <div id='stage5' style='display: none; width: {{option.width}}px; height: {{(option.height-option.fontsize)/2+option.fontsize}}px; color: white; font-size: {{option.fontsize}}px; padding-top: {{(option.height-option.fontsize)/2}}px; line-height: 1; text-align: center;'>
      TEST WORD LIST 단어 하나 둘 셋
    </div>
  </div>
</body>
</html>